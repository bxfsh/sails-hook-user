<!DOCTYPE html>
<html class="authentication-form">
  <head>
    <title><%= typeof title !== 'undefined' ? title + ' | Boxfish' : 'Boxfish' %></title>
    <!-- Viewport mobile tag for sensible mobile support -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/stylesheets/login.css">
  </head>

  <body data-env="<%= sails.config.env %>">

    <!--TEMPLATES-->
    <script src="/jst.js"></script>
    <!--TEMPLATES END-->

    <script src="https://cdn.ravenjs.com/1.3.0/jquery,native/raven.min.js"></script>
    <!--SCRIPTS-->
    <!--SCRIPTS END-->


    <%- body %>


    <% if (req.session.notificationError){ %>
    <script>
      noty({
        type: 'error',
        text: <%- JSON.stringify(req.session.notificationError) %>,
        timeout: 6000
      });
      <% delete req.session.notificationError %>
    </script>
    <% } %>

    <script>
      // G Analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      <% if (sails.config.env === 'dev') {%>
        console.log('GA tracking code: %c UA-67412132-1', ';color: #6695DC;')
        ga('create', 'UA-67412132-1', 'auto');
      <% } else { %>
        console.log('GA tracking code: %c UA-67412132-3', ';color: #6695DC;')
        ga('create', 'UA-67412132-3', 'auto');
      <% } %>

      ga('send', 'pageview');

      /**
       * sends a GA event, used to centralise the events and pages name
       * @param {String} root
       * @param {String} page
       * @param {String} section
       * @param {String} action
       * @param {String} value
       */
      window.sendGAEvent = function sendGAEvent(root, page, section, action, value) {

        // normalising the root name
        if (/audience/ig.test(root)) root = 'audiences';
        if (/project/ig.test(root)) root = 'projects';

        console.info(
          'tracking: %c' + root + ' ' + page +
          (' ' + (section || '')) +
          (' ' + (action || '')) +
          (' ' + (value || '')), ';color: #6695DC;');

				ga('send', 'event', root, page, section, action, value);

        <%if (typeof req.session.user !== 'undefined') {%>
          ga('send', 'event', '<%= req.session.user.email %>', root, page, section, action, value, new Date().toISOString());
        <%}%>

      };

      <%if (req.session.user) {%>
        sendGAEvent('user page request', '<%= req.session.user.email %>', window.location.href);
      <%}%>

      // Sentry configuration
      <% if (sails.config.env === 'dev') {%>
        // dev
        Raven.config('https://57ddbec2382c4d02b3fc420a82fc3fd8@app.getsentry.com/59627').install();
      <% } else {%>
        // prod
        Raven.config('https://1aaa7d20cef449318c8a056e2382fad4@app.getsentry.com/59625').install()
      <% } %>

      <% if (req.session.user) { %>
        // Set the user context for raven error logging
        Raven.setUserContext({
          email: '<%= req.session.user.email %>',
          id: '<%= req.session.user.id %>'
        });
      <% } %>

      // All ajax errors in the page
      $(document).ajaxError(function(event, jqxhr, settings, thrownError) {
        console.warn(arguments);
        ga('send', 'exception', {
          'exDescription': JSON.stringify(thrownError),
          'exFatal': false
        });
        Raven.captureException(event);
      });

      // genre
      <%if (typeof genre !== 'undefined') { %>
        window.genre = '<%= genre %>';
      <%}%>

    </script>

    <script>
    <% if ( typeof req.session.user !== 'undefined' ) { %>
      // adding user to the window
      window.user = {};
      window.user.email = '<%= req.session.user.email %>';
    <% } %>
    </script>

  </body>
</html>
